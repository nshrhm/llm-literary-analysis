# 温度設定ガイドライン

## 基本方針（2025-04-11更新）
文学解析の質を高めるため、以下の3要素を統合的に制御する：
1. ペルソナの特性に基づく基本温度設定
2. テキストの性質による温度調整
3. プロンプト制御とパターンマッチングによる品質保証

## プロンプト制御ガイドライン（2025-04-11追加）
1. プロンプト構造
   ```python
   enhanced_prompt = f"""
   {system}

   重要：必ず以下の形式で回答してください。各項目の数値を必ず記入してください。

   {user}

   注意：
   - 必ず数値を[0-100]の範囲で明示的に記入してください
   - 各項目の(数値)と(理由)を明確に分けて記述してください
   - 形式は厳密に守ってください
   """
   ```

2. 応答形式の定義
   - Q1-Q4の質問形式を統一
   - 数値と理由の明確な分離
   - 範囲（0-100）の明示的な指定

3. 品質管理基準
   - 必須フィールドの存在確認
   - 数値範囲の検証（0-100）
   - 理由の記述確認

## パラメータ定義（2025-04-11更新）

1. ペルソナベースの基本温度（base_temperature）
各ペルソナの性質を反映した基本温度を設定：

| ペルソナ | 温度値 | 根拠 |
|---------|--------|------|
| 大学1年生 | 0.7 | 若く柔軟な発想を持ち、多様な解釈を生成 |
| 文学研究者 | 0.4 | 論理的で分析的なアプローチを重視 |
| 感情豊かな詩人 | 0.9 | 高い創造性と感情表現の自由度を確保 |
| 無感情なロボット | 0.1 | 一貫性のある機械的な判断を維持 |

2. テキスト特性による調整（temperature_modifier）
テキストの性質に応じて基本温度を微調整：

| テキスト | 基本修正値 | 調整範囲 | 考慮点 |
|---------|------------|----------|--------|
| 寓話的 | 0.0 | ±0.1 | 教訓性と物語性のバランス |
| 物語的 | 0.0 | ±0.2 | 展開の自然さと解釈の多様性 |
| 詩的 | 0.0 | ±0.3 | 韻律と象徴性の表現 |

## 実装規則（2025-04-11更新）

### パターンマッチング設定
1. 応答抽出パターン
```python
patterns = [
    rf"Q\d+\.\s*{question}\(数値\):\s*(\d+)",  # 標準形式
    rf"Q\d+\.\s*{question}:\s*\(数値\):\s*(\d+)",  # 代替形式1
    rf"Q\d+\.\s*{question}\s*数値:\s*(\d+)",  # 代替形式2
    rf"Q\d+\.\s*{question}:\s*(\d+)",  # シンプル形式
    rf"{question}(?:の評価)?(?:\s*[:：]\s*|\s+)(\d+)",  # 日本語形式1
    rf"{question}(?:度|レベル)(?:\s*[:：]\s*|\s+)(\d+)",  # 日本語形式2
    rf"「{question}」\s*[:：]?\s*(\d+)",  # 括弧形式
    rf"\[{question}\]\s*[:：]?\s*(\d+)"  # 角括弧形式
]
```

2. 抽出プロセス
   - 優先順位の高い順にパターンを適用
   - 最初にマッチしたパターンを採用
   - マッチしない場合は次のパターンを試行

### 品質管理プロセス
1. 応答検証
```python
def validate_response(response):
    """応答の品質検証"""
    required_fields = ["面白さ", "驚き", "悲しみ", "怒り"]
    for field in required_fields:
        value = extract_value(response, field)
        if not value or not (0 <= int(value) <= 100):
            return False
    return True
```

2. エラー回復
```python
def handle_invalid_response(model, prompt, max_retries=3):
    """無効な応答のリカバリー"""
    for attempt in range(max_retries):
        response = model.generate_content(prompt)
        if validate_response(response):
            return response
    raise ValidationError("Maximum retries exceeded")
```

### 温度制御規則
1. 温度値の計算
```python
final_temperature = base_temperature + temperature_modifier
```

2. 制約条件
   - 最終温度は0.0-1.0の範囲内に収める
   - 範囲を超える場合は警告を記録
   - 推論モデルは温度設定を使用しない

3. 結果の記録
   - 標準モデル：temperature値を記録
   - 推論モデル：Noneとして記録

## モデル別の考慮事項（2025-04-11更新）

### 1. Geminiモデル
- プロンプト強化の適用
- パターンマッチングの完全サポート
- 品質管理システムの統合
- 長時間実行時の安定性確保

### 2. 生成モデル
- temperaturesパラメータを必ず使用
- ペルソナとテキストの組み合わせを考慮
- 応答形式の統一性を維持

### 3. 推論モデル
- temperaturesパラメータを使用しない
- 一貫性のある応答を重視
- 標準フォーマットの遵守

## 結果の検証（2025-04-11更新）

### 1. 品質指標
- 応答の一貫性
- 解釈の多様性
- ペルソナ特性の反映度
- パターンマッチング成功率
- エラー回復の効率性

### 2. モニタリング項目
- 温度設定と感情スコアの相関
- ペルソナ別の応答パターン
- テキスト種別による変動
- プロンプト応答の品質
- パターンマッチングの精度

## 更新履歴
### 2025-04-11:
- 初版作成: 温度設定の基本方針を定義
- プロンプト制御ガイドラインの追加
- パターンマッチングシステムの実装
- 品質管理プロセスの確立
- Geminiモデル対応の追加
