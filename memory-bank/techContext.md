# 技術コンテキスト

## 開発環境

### 言語とバージョン
- Python 3.12
- UTF-8エンコーディング
- 日本語テキスト処理対応

### 依存関係
- google-generativeai>=0.3.0
- anthropic>=0.43.0
- openai>=1.0.0
- pytest>=7.4.0

## 技術仕様

### ファイル名形式
1. 標準形式
```
{text}_{model}_{persona}_temp{temperature}_{trial}
例：t1_gpt-4o_p1_temp50_01
```

2. temperatureなしモデル
```
{text}_{model}_{persona}_temp--_{trial}
例：t1_gpt-4o_p1_temp--_01
```

### 出力ファイル形式
1. メタデータの標準順序
```
timestamp: YYYY-MM-DD HH:MM:SS
text: t1
model: gpt-4.1
persona: p1
trial: 1  # 整数値表示（01 → 1）
temperature: 0.7  # または None
```

2. GPT-4.1シリーズの価格情報
```json
pricing: {
  "input": 2.00,
  "cached_input": 0.50,
  "output": 8.00
}
```

### パターンマッチング
1. 応答形式の検証パターン
- 標準形式: `Q1. 面白さ(数値): 80`
- 代替形式1: `Q1. 面白さ: (数値): 80`
- 代替形式2: `Q1. 面白さ 数値: 80`
- シンプル形式: `Q1. 面白さ: 80`
- 日本語形式1: `面白さの評価: 80`
- 日本語形式2: `面白さレベル: 80`
- 括弧形式: `「面白さ」: 80`
- 角括弧形式: `[面白さ]: 80`

### 試行番号の処理
1. 入力形式
- 標準: `01`, `02`, ..., `10`
- nプレフィックス付き: `n01`, `n02`, ..., `n10`

2. 出力形式
- すべて整数値として表示: `1`, `2`, ..., `10`
- メタデータ内では文字列として保存

### エラーハンドリング
1. バリデーション
- 数値範囲チェック（0-100）
- 理由の存在確認
- メタデータの完全性確認

2. 統計情報
- 成功件数
- 部分的成功（一部検証エラー）
- 失敗件数

### テスト要件
1. 単体テスト
- パターンマッチングの検証
- メタデータ処理の確認
- ファイル出力の検証

2. 統合テスト
- バッチ処理の一貫性
- エラーハンドリング
- 出力ファイルの整合性

## APIインターフェース

### OpenAI APIの利用
- Chat Completions API
- JSONLバッチ処理
- モデル固有の価格設定

### kluster.ai API
- OpenAI互換インターフェース
- Llama/DeepSeekモデル対応
- API認証キー管理

### Claude API
- Message Batches API
- バッチサイズ最適化
- 結果保持期間管理

### Gemini API
- Chat API
- マルチモーダル対応
- 安全性フィルター

## パフォーマンス最適化

### バッチ処理
- 最適バッチサイズ: 20-50リクエスト
- 並列処理の制限
- メモリ使用量の管理

### ストレージ
- 結果ファイルの圧縮
- メタデータの効率的な保存
- バックアップ戦略

### エラー処理
- 自動リトライ
- 部分的失敗の回復
- ログ記録と分析
